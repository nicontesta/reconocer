<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Conversor HTML a Markdown</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Librerías para previsualización -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
  
  <!-- Estilo GitHub Markdown -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
  
  <style>
    :root {
      --font-main: 'Courier New', monospace;
      --background-color: #fbfbf6;
      --text-color: #333;
      --border-color: #ccc;
      --button-color: #27ae60;
      --button-hover: #2ecc71;
      --preview-bg: #ffffff;
      --toc-bg: rgba(251, 251, 246, 0.95);
      --toc-border: 1px solid #ccc;
      --toc-width: 240px;
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --background-color: #1f1d25;
        --text-color: #ededed;
        --border-color: #444;
        --preview-bg: #2d2d2d;
        --toc-bg: rgba(31, 29, 37, 0.95);
        --toc-border: 1px solid #444;
      }
      
      .markdown-body {
        color-scheme: dark;
        --color-prettylights-syntax-comment: #8b949e;
        --color-prettylights-syntax-constant: #79c0ff;
        --color-prettylights-syntax-entity: #d2a8ff;
        --color-prettylights-syntax-storage-modifier-import: #c9d1d9;
        --color-prettylights-syntax-entity-tag: #7ee787;
        --color-prettylights-syntax-keyword: #ff7b72;
        --color-prettylights-syntax-string: #a5d6ff;
        --color-prettylights-syntax-variable: #ffa657;
        --color-prettylights-syntax-brackethighlighter-unmatched: #f85149;
        --color-prettylights-syntax-invalid-illegal-text: #f0f6fc;
        --color-prettylights-syntax-invalid-illegal-bg: #8e1519;
        --color-prettylights-syntax-carriage-return-text: #f0f6fc;
        --color-prettylights-syntax-carriage-return-bg: #b62324;
        --color-prettylights-syntax-string-regexp: #7ee787;
        --color-prettylights-syntax-markup-list: #f2cc60;
        --color-prettylights-syntax-markup-heading: #1f6feb;
        --color-prettylights-syntax-markup-italic: #c9d1d9;
        --color-prettylights-syntax-markup-bold: #c9d1d9;
        --color-prettylights-syntax-markup-deleted-text: #ffdcd7;
        --color-prettylights-syntax-markup-deleted-bg: #67060c;
        --color-prettylights-syntax-markup-inserted-text: #aff5b4;
        --color-prettylights-syntax-markup-inserted-bg: #033a16;
        --color-prettylights-syntax-markup-changed-text: #ffdfb6;
        --color-prettylights-syntax-markup-changed-bg: #5a1e02;
        --color-prettylights-syntax-markup-ignored-text: #c9d1d9;
        --color-prettylights-syntax-markup-ignored-bg: #1158c7;
        --color-prettylights-syntax-meta-diff-range: #d2a8ff;
        --color-prettylights-syntax-brackethighlighter-angle: #8b949e;
        --color-prettylights-syntax-sublimelinter-gutter-mark: #484f58;
        --color-prettylights-syntax-constant-other-reference-link: #a5d6ff;
        --color-fg-default: #e6edf3;
        --color-fg-muted: #9198a1;
        --color-fg-subtle: #6e7681;
        --color-canvas-default: #0d1117;
        --color-canvas-subtle: #161b22;
        --color-border-default: #30363d;
        --color-border-muted: #21262d;
        --color-neutral-muted: rgba(110,118,129,0.4);
        --color-accent-fg: #2f81f7;
        --color-accent-emphasis: #1f6feb;
        --color-success-fg: #3fb950;
        --color-success-emphasis: #238636;
        --color-attention-fg: #d29922;
        --color-attention-emphasis: #9e6a03;
        --color-danger-fg: #f85149;
        --color-danger-emphasis: #da3633;
        --color-done-fg: #a371f7;
        --color-done-emphasis: #8957e5;
      }
    }
    
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background-color: var(--background-color);
      color: var(--text-color);
      max-width: 1000px;
      margin: 0 auto;
    }
    
    h1, h2 {
      font-family: var(--font-main);
    }
    
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    
    .panel {
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 15px;
      background-color: var(--background-color);
    }
    
    textarea {
      width: 100%;
      min-height: 300px;
      font-family: monospace;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--background-color);
      color: var(--text-color);
    }
    
    .button {
      background-color: var(--button-color);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      margin-right: 10px;
      transition: background-color 0.3s;
    }
    
    .button:hover {
      background-color: var(--button-hover);
    }
    
    .button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    .instructions {
      background-color: rgba(0, 0, 0, 0.05);
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .instructions ol {
      padding-left: 20px;
    }
    
    .instructions li {
      margin-bottom: 10px;
    }
    
    .output {
      white-space: pre-wrap;
      font-family: monospace;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      min-height: 300px;
      max-height: 500px;
      overflow-y: auto;
    }
    
    /* Estilos para la ventana de previsualización */
    .preview-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 80%;
      background-color: var(--preview-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      overflow: hidden;
      flex-direction: column;
    }
    
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--background-color);
    }
    
    .preview-title {
      margin: 0;
      font-size: 18px;
      font-weight: bold;
    }
    
    .preview-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-color);
    }
    
    .preview-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .preview-body {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background-color: var(--preview-bg);
    }
    
    .preview-toc {
      width: var(--toc-width);
      padding: 15px;
      border-right: var(--toc-border);
      background-color: var(--toc-bg);
      overflow-y: auto;
      display: none;
    }
    
    @media (min-width: 1024px) {
      .preview-toc {
        display: block;
      }
    }
    
    .preview-toc-header {
      font-weight: bold;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .preview-toc ul {
      list-style: none;
      padding-left: 10px;
    }
    
    .preview-toc li {
      margin: 5px 0;
    }
    
    .preview-toc a {
      color: var(--text-color);
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
    }
    
    .preview-toc a:hover {
      text-decoration: underline;
    }
    
    .markdown-body {
      box-sizing: border-box;
      min-width: 200px;
      max-width: 980px;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--preview-bg);
    }
    
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    
    .button-group {
      display: flex;
      margin-top: 10px;
    }
    
    .url-input {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--background-color);
      color: var(--text-color);
    }
    
    .url-input-label {
      display: block;
      margin-top: 15px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Conversor HTML a Markdown</h1>
  
  <div class="instructions">
    <h2>¿Cómo usar esta herramienta?</h2>
    <ol>
      <li>Abre las herramientas de desarrollador de tu navegador (F12 o clic derecho → Inspeccionar)</li>
      <li>Selecciona el elemento que quieres convertir usando el selector (icono de flecha en la esquina superior izquierda de las herramientas de desarrollador)</li>
      <li>Una vez seleccionado el elemento, haz clic derecho sobre él en el inspector</li>
      <li>Selecciona "Copiar" → "Copiar elemento" o "Copy" → "Copy element"</li>
      <li>Pega el HTML copiado en el área de la izquierda</li>
      <li>Si el HTML tiene enlaces relativos, introduce la URL base para corregirlos (opcional)</li>
      <li>Haz clic en "Convertir a Markdown"</li>
      <li>Usa los botones "Previsualizar" o "Descargar Markdown" según necesites</li>
    </ol>
    <p><strong>Nota:</strong> Esta herramienta funciona completamente en tu navegador. Tu HTML no se envía a ningún servidor.</p>
  </div>
  
  <div class="container">
    <div class="panel">
      <h2>HTML de entrada</h2>
      <textarea id="html-input" placeholder="Pega tu HTML aquí..."></textarea>
      <button id="convert-btn" class="button">Convertir a Markdown</button>
      
      <label class="url-input-label" for="base-url">URL base (para enlaces relativos):</label>
      <input type="text" id="base-url" class="url-input" placeholder="https://ejemplo.com/ruta/">
    </div>
    
    <div class="panel">
      <h2>Resultado Markdown</h2>
      <div id="markdown-output" class="output">El resultado aparecerá aquí...</div>
      <div class="button-group">
        <button id="preview-btn" class="button" disabled>Previsualizar</button>
        <button id="download-btn" class="button" disabled>Descargar Markdown</button>
      </div>
    </div>
  </div>

  <!-- Ventana de previsualización -->
  <div class="overlay" id="preview-overlay"></div>
  <div class="preview-modal" id="preview-modal">
    <div class="preview-header">
      <h3 class="preview-title">Previsualización de Markdown</h3>
      <button class="preview-close" id="preview-close">&times;</button>
    </div>
    <div class="preview-content">
      <div class="preview-toc" id="preview-toc">
        <div class="preview-toc-header">ÍNDICE</div>
        <div id="toc-content"></div>
      </div>
      <div class="preview-body">
        <div class="markdown-body" id="preview-rendered"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/turndown@7.1.1/dist/turndown.js"></script>
  <script>
    // Almacenamiento del último Markdown generado
    let lastGeneratedMarkdown = '';
    
    document.addEventListener('DOMContentLoaded', function() {
      const htmlInput = document.getElementById('html-input');
      const convertBtn = document.getElementById('convert-btn');
      const markdownOutput = document.getElementById('markdown-output');
      const downloadBtn = document.getElementById('download-btn');
      const previewBtn = document.getElementById('preview-btn');
      const previewModal = document.getElementById('preview-modal');
      const previewOverlay = document.getElementById('preview-overlay');
      const previewClose = document.getElementById('preview-close');
      const previewRendered = document.getElementById('preview-rendered');
      const tocContent = document.getElementById('toc-content');
      const baseUrlInput = document.getElementById('base-url');
      
      // Configuración de Turndown
      function configureTurndown() {
        const turndownService = new TurndownService({
          headingStyle: 'atx',
          codeBlockStyle: 'fenced',
          fence: '```'
        });
        
        // Reglas personalizadas
        turndownService.addRule('codeBlocks', {
          filter: function(node) {
            return node.nodeName === 'PRE' && node.firstChild && node.firstChild.nodeName === 'CODE';
          },
          replacement: function(content, node) {
            let language = '';
            if (node.firstChild.className) {
              const match = node.firstChild.className.match(/language-(\w+)/);
              if (match) language = match[1];
            }
            return '\n\n```' + language + '\n' + node.firstChild.textContent + '\n```\n\n';
          }
        });
        
        turndownService.addRule('inlineCode', {
          filter: function(node) {
            return node.nodeName === 'CODE' && 
                   (!node.parentNode || node.parentNode.nodeName !== 'PRE');
          },
          replacement: function(content) {
            return '`' + content + '`';
          }
        });
        
        turndownService.addRule('images', {
          filter: 'img',
          replacement: function(content, node) {
            const alt = node.alt || '';
            const src = node.src || '';
            return '![' + alt + '](' + src + ')';
          }
        });
        
        turndownService.addRule('tables', {
          filter: 'table',
          replacement: function(content, node) {
            const rows = node.querySelectorAll('tr');
            let markdown = '';
            
            // Procesar encabezados
            const headerCells = rows[0].querySelectorAll('th, td');
            let headerRow = '|';
            let separatorRow = '|';
            
            for (let i = 0; i < headerCells.length; i++) {
              const cellContent = turndownService.turndown(headerCells[i].innerHTML).trim();
              headerRow += ' ' + cellContent + ' |';
              separatorRow += ' --- |';
            }
            
            markdown += headerRow + '\n' + separatorRow + '\n';
            
            // Procesar filas de datos
            for (let i = 1; i < rows.length; i++) {
              const cells = rows[i].querySelectorAll('td');
              let row = '|';
              
              for (let j = 0; j < cells.length; j++) {
                const cellContent = turndownService.turndown(cells[j].innerHTML).trim();
                row += ' ' + cellContent + ' |';
              }
              
              markdown += row + '\n';
            }
            
            return '\n\n' + markdown + '\n';
          }
        });
        
        // Mantener fórmulas matemáticas como MathML
        turndownService.addRule('mathFormulas', {
          filter: function(node) {
            return (node.classList && (
              node.classList.contains('MathJax') || 
              node.classList.contains('math') ||
              node.tagName === 'MJX-CONTAINER'
            ));
          },
          replacement: function(content, node) {
            return node.innerHTML;
          }
        });
        
        return turndownService;
      }
      
      // Función para descargar texto como archivo
      function downloadTextAsFile(text, filename) {
        const blob = new Blob([text], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
      }
      
      // Función para limpiar el Markdown resultante
      function cleanMarkdown(markdown) {
        return markdown
          .replace(/\n\s*\n\s*\n/g, '\n\n')
          .replace(/```\s*\n\s*```/g, '')
          .replace(/^[ \t]+|[ \t]+$/gm, '')
          .replace(/([^\n])\n(#+ )/g, '$1\n\n$2')
          .replace(/\|\s+\n/g, '|\n')
          .replace(/\|\s+$/gm, '|')
          .trim();
      }
      
      // Función para corregir enlaces relativos
      function fixRelativeLinks(html, baseUrl) {
        if (!baseUrl) return html;
        
        // Crear un elemento temporal para manipular el HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // Corregir enlaces
        const links = tempDiv.querySelectorAll('a[href]');
        links.forEach(link => {
          const href = link.getAttribute('href');
          // Si es un enlace relativo (que no comienza con http o //)
          if (href && !href.startsWith('http') && !href.startsWith('//') && !href.startsWith('#')) {
            try {
              // Crear una URL absoluta
              const absoluteUrl = new URL(href, baseUrl).href;
              link.setAttribute('href', absoluteUrl);
            } catch (e) {
              console.error('Error al corregir enlace:', e);
            }
          }
        });
        
        // Corregir imágenes
        const images = tempDiv.querySelectorAll('img[src]');
        images.forEach(img => {
          const src = img.getAttribute('src');
          // Si es una ruta relativa
          if (src && !src.startsWith('http') && !src.startsWith('//') && !src.startsWith('data:')) {
            try {
              // Crear una URL absoluta
              const absoluteUrl = new URL(src, baseUrl).href;
              img.setAttribute('src', absoluteUrl);
            } catch (e) {
              console.error('Error al corregir imagen:', e);
            }
          }
        });
        
        return tempDiv.innerHTML;
      }
      
      // Función para generar TOC a partir del HTML renderizado
      function generateTOC(htmlContent) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;
        const headings = tempDiv.querySelectorAll('h1, h2, h3, h4, h5, h6');
        let tocHTML = '<ul>';
        
        headings.forEach((heading, index) => {
          // Añadir ID si no tiene
          if (!heading.id) {
            heading.id = `heading-${index}`;
          }
          
          const level = parseInt(heading.tagName.substring(1));
          const indent = (level - 1) * 15;
          
          tocHTML += `
            <li style="margin-left: ${indent}px;">
              <a onclick="scrollToHeading('${heading.id}')">
                ${heading.textContent}
              </a>
            </li>
          `;
        });
        
        tocHTML += '</ul>';
        return {tocHTML, headings};
      }
      
      // Función para desplazarse a un encabezado en la previsualización
      window.scrollToHeading = function(id) {
        const heading = previewRendered.querySelector('#' + id);
        if (heading) {
          heading.scrollIntoView({ behavior: 'smooth' });
          
          // Resaltar temporalmente el encabezado
          heading.style.backgroundColor = 'rgba(255, 255, 0, 0.2)';
          setTimeout(() => {
            heading.style.backgroundColor = '';
          }, 1000);
        }
      };
      
      // Evento para el botón de conversión
      convertBtn.addEventListener('click', function() {
        const html = htmlInput.value.trim();
        const baseUrl = baseUrlInput.value.trim();
        
        if (!html) {
          alert('Por favor, introduce algún HTML para convertir.');
          return;
        }
        
        try {
          // Corregir enlaces relativos si se proporciona una URL base
          const correctedHtml = baseUrl ? fixRelativeLinks(html, baseUrl) : html;
          
          const turndownService = configureTurndown();
          const markdown = turndownService.turndown(correctedHtml);
          const cleanedMarkdown = cleanMarkdown(markdown);
          
          markdownOutput.textContent = cleanedMarkdown;
          downloadBtn.disabled = false;
          previewBtn.disabled = false;
          
          // Guardar el markdown para reutilización
          lastGeneratedMarkdown = cleanedMarkdown;
        } catch (error) {
          console.error('Error al convertir:', error);
          markdownOutput.textContent = 'Error al convertir el HTML. Por favor, verifica que es HTML válido.';
          downloadBtn.disabled = true;
          previewBtn.disabled = true;
        }
      });
      
      // Evento para el botón de descarga
      downloadBtn.addEventListener('click', function() {
        if (lastGeneratedMarkdown) {
          downloadTextAsFile(lastGeneratedMarkdown, 'converted.md');
        }
      });
      
      // Evento para el botón de previsualización
      previewBtn.addEventListener('click', function() {
        if (!lastGeneratedMarkdown) return;
        
        // Convertir Markdown a HTML usando marked
        const rawHtml = marked.parse(lastGeneratedMarkdown);
        
        // Sanitizar el HTML para prevenir XSS
        const cleanHtml = DOMPurify.sanitize(rawHtml);
        
        // Mostrar el HTML en la previsualización
        previewRendered.innerHTML = cleanHtml;
        
        // Generar TOC
        const {tocHTML, headings} = generateTOC(cleanHtml);
        tocContent.innerHTML = tocHTML;
        
        // Asegurarse de que los encabezados en el preview tengan los mismos IDs
        headings.forEach((heading, index) => {
          const previewHeading = previewRendered.querySelector(`h${heading.tagName.substring(1)}:nth-child(${index + 1})`);
          if (previewHeading && !previewHeading.id) {
            previewHeading.id = heading.id;
          }
        });
        
        // Mostrar la ventana de previsualización
        previewModal.style.display = 'flex';
        previewOverlay.style.display = 'block';
        
        // Desplazarse al principio del contenido
        previewRendered.scrollTop = 0;
      });
      
      // Evento para cerrar la previsualización
      previewClose.addEventListener('click', function() {
        previewModal.style.display = 'none';
        previewOverlay.style.display = 'none';
      });
      
      // Cerrar previsualización al hacer clic fuera
      previewOverlay.addEventListener('click', function() {
        previewModal.style.display = 'none';
        previewOverlay.style.display = 'none';
      });
      
      // Ejemplo de HTML para probar
      htmlInput.value = `<!-- Puedes pegar tu HTML aquí para probar -->
<h1>Título de ejemplo</h1>
<p>Este es un párrafo con <strong>texto en negrita</strong> y <em>texto en cursiva</em>.</p>
<ul>
  <li>Elemento de lista 1</li>
  <li>Elemento de lista 2</li>
</ul>
<pre><code class="language-javascript">// Código de ejemplo
function hello() {
  console.log("Hola mundo");
}</code></pre>

<h2>Subtítulo</h2>
<p>Más contenido de ejemplo con un <a href="/ruta/relativa">enlace relativo</a>.</p>

<h3>Sub-subtítulo</h3>
<p>Texto adicional para demostrar la tabla de contenidos.</p>`;
    });
  </script>
</body>
</html>
