<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Conversor HTML a Markdown</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --font-main: 'Courier New', monospace;
      --background-color: #fbfbf6;
      --text-color: #333;
      --border-color: #ccc;
      --button-color: #27ae60;
      --button-hover: #2ecc71;
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --background-color: #1f1d25;
        --text-color: #ededed;
        --border-color: #444;
      }
    }
    
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background-color: var(--background-color);
      color: var(--text-color);
      max-width: 1000px;
      margin: 0 auto;
    }
    
    h1, h2 {
      font-family: var(--font-main);
    }
    
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    
    .panel {
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 15px;
      background-color: var(--background-color);
    }
    
    textarea {
      width: 100%;
      min-height: 300px;
      font-family: monospace;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--background-color);
      color: var(--text-color);
    }
    
    .button {
      background-color: var(--button-color);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      transition: background-color 0.3s;
    }
    
    .button:hover {
      background-color: var(--button-hover);
    }
    
    .instructions {
      background-color: rgba(0, 0, 0, 0.05);
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .instructions ol {
      padding-left: 20px;
    }
    
    .instructions li {
      margin-bottom: 10px;
    }
    
    .output {
      white-space: pre-wrap;
      font-family: monospace;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      min-height: 300px;
      max-height: 500px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>Conversor HTML a Markdown</h1>
  
  <div class="instructions">
    <h2>¿Cómo usar esta herramienta?</h2>
    <ol>
      <li>Abre las herramientas de desarrollador de tu navegador (F12 o clic derecho → Inspeccionar)</li>
      <li>Selecciona el elemento que quieres convertir usando el selector (icono de flecha en la esquina superior izquierda de las herramientas de desarrollador)</li>
      <li>Una vez seleccionado el elemento, haz clic derecho sobre él en el inspector</li>
      <li>Selecciona "Copiar" → "Copiar elemento" o "Copy" → "Copy element"</li>
      <li>Pega el HTML copiado en el área de la izquierda</li>
      <li>Haz clic en "Convertir a Markdown"</li>
      <li>Descarga el resultado con el botón "Descargar Markdown"</li>
    </ol>
    <p><strong>Nota:</strong> Esta herramienta funciona completamente en tu navegador. Tu HTML no se envía a ningún servidor.</p>
  </div>
  
  <div class="container">
    <div class="panel">
      <h2>HTML de entrada</h2>
      <textarea id="html-input" placeholder="Pega tu HTML aquí..."></textarea>
      <button id="convert-btn" class="button">Convertir a Markdown</button>
    </div>
    
    <div class="panel">
      <h2>Resultado Markdown</h2>
      <div id="markdown-output" class="output">El resultado aparecerá aquí...</div>
      <button id="download-btn" class="button" disabled>Descargar Markdown</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/turndown@7.1.1/dist/turndown.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const htmlInput = document.getElementById('html-input');
      const convertBtn = document.getElementById('convert-btn');
      const markdownOutput = document.getElementById('markdown-output');
      const downloadBtn = document.getElementById('download-btn');
      
      // Configuración de Turndown
      function configureTurndown() {
        const turndownService = new TurndownService({
          headingStyle: 'atx',
          codeBlockStyle: 'fenced',
          fence: '```'
        });
        
        // Reglas personalizadas
        turndownService.addRule('codeBlocks', {
          filter: function(node) {
            return node.nodeName === 'PRE' && node.firstChild && node.firstChild.nodeName === 'CODE';
          },
          replacement: function(content, node) {
            let language = '';
            if (node.firstChild.className) {
              const match = node.firstChild.className.match(/language-(\w+)/);
              if (match) language = match[1];
            }
            return '\n\n```' + language + '\n' + node.firstChild.textContent + '\n```\n\n';
          }
        });
        
        turndownService.addRule('inlineCode', {
          filter: function(node) {
            return node.nodeName === 'CODE' && 
                   (!node.parentNode || node.parentNode.nodeName !== 'PRE');
          },
          replacement: function(content) {
            return '`' + content + '`';
          }
        });
        
        turndownService.addRule('images', {
          filter: 'img',
          replacement: function(content, node) {
            const alt = node.alt || '';
            const src = node.src || '';
            return '![' + alt + '](' + src + ')';
          }
        });
        
        turndownService.addRule('tables', {
          filter: 'table',
          replacement: function(content, node) {
            const rows = node.querySelectorAll('tr');
            let markdown = '';
            
            // Procesar encabezados
            const headerCells = rows[0].querySelectorAll('th, td');
            let headerRow = '|';
            let separatorRow = '|';
            
            for (let i = 0; i < headerCells.length; i++) {
              const cellContent = turndownService.turndown(headerCells[i].innerHTML).trim();
              headerRow += ' ' + cellContent + ' |';
              separatorRow += ' --- |';
            }
            
            markdown += headerRow + '\n' + separatorRow + '\n';
            
            // Procesar filas de datos
            for (let i = 1; i < rows.length; i++) {
              const cells = rows[i].querySelectorAll('td');
              let row = '|';
              
              for (let j = 0; j < cells.length; j++) {
                const cellContent = turndownService.turndown(cells[j].innerHTML).trim();
                row += ' ' + cellContent + ' |';
              }
              
              markdown += row + '\n';
            }
            
            return '\n\n' + markdown + '\n';
          }
        });
        
        // Mantener fórmulas matemáticas como MathML
        turndownService.addRule('mathFormulas', {
          filter: function(node) {
            return (node.classList && (
              node.classList.contains('MathJax') || 
              node.classList.contains('math') ||
              node.tagName === 'MJX-CONTAINER'
            ));
          },
          replacement: function(content, node) {
            return node.innerHTML;
          }
        });
        
        return turndownService;
      }
      
      // Función para descargar texto como archivo
      function downloadTextAsFile(text, filename) {
        const blob = new Blob([text], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
      }
      
      // Función para limpiar el Markdown resultante
      function cleanMarkdown(markdown) {
        return markdown
          .replace(/\n\s*\n\s*\n/g, '\n\n')
          .replace(/```\s*\n\s*```/g, '')
          .replace(/^[ \t]+|[ \t]+$/gm, '')
          .replace(/([^\n])\n(#+ )/g, '$1\n\n$2')
          .replace(/\|\s+\n/g, '|\n')
          .replace(/\|\s+$/gm, '|')
          .trim();
      }
      
      // Evento para el botón de conversión
      convertBtn.addEventListener('click', function() {
        const html = htmlInput.value.trim();
        
        if (!html) {
          alert('Por favor, introduce algún HTML para convertir.');
          return;
        }
        
        try {
          const turndownService = configureTurndown();
          const markdown = turndownService.turndown(html);
          const cleanedMarkdown = cleanMarkdown(markdown);
          
          markdownOutput.textContent = cleanedMarkdown;
          downloadBtn.disabled = false;
          
          // Guardar el markdown para la descarga
          downloadBtn.markdownContent = cleanedMarkdown;
        } catch (error) {
          console.error('Error al convertir:', error);
          markdownOutput.textContent = 'Error al convertir el HTML. Por favor, verifica que es HTML válido.';
          downloadBtn.disabled = true;
        }
      });
      
      // Evento para el botón de descarga
      downloadBtn.addEventListener('click', function() {
        if (this.markdownContent) {
          downloadTextAsFile(this.markdownContent, 'converted.md');
        }
      });
      
      // Ejemplo de HTML para probar
      htmlInput.value = `<!-- Puedes pegar tu HTML aquí para probar -->
<h1>Título de ejemplo</h1>
<p>Este es un párrafo con <strong>texto en negrita</strong> y <em>texto en cursiva</em>.</p>
<ul>
  <li>Elemento de lista 1</li>
  <li>Elemento de lista 2</li>
</ul>
<pre><code class="language-javascript">// Código de ejemplo
function hello() {
  console.log("Hola mundo");
}</code></pre>`;
    });
  </script>
</body>
</html>